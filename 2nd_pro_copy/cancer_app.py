"""
============================================================
π”¬ AI κΈ°λ° ν™μ λ§μ¶¤ν• μ‹ ν•­μ› λ°κµ΄ λ° μ•” λ°±μ‹  μ„¤κ³„ μ‹μ¤ν…
============================================================
"""

import streamlit as st
import numpy as np
import tensorflow as tf
import pandas as pd
import plotly.graph_objects as go
import time

# ============================================================
# νμ΄μ§€ μ„¤μ •
# ============================================================
st.set_page_config(
    page_title="AI μ•” λ°±μ‹  μ„¤κ³„ μ‹μ¤ν…",
    page_icon="π”¬",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ============================================================
# μ•„λ―Έλ…Έμ‚° μ΄λ¦„ λ”•μ…”λ„λ¦¬ μ •μ (μ—λ¬ μμ •)
# ============================================================
aa_name = {
    'A': 'μ•λΌλ‹', 'C': 'μ‹μ¤ν…μΈ', 'D': 'μ•„μ¤νλ¥΄νΈμ‚°', 'E': 'κΈ€λ£¨νƒμ‚°',
    'F': 'νλ‹μ•λΌλ‹', 'G': 'κΈ€λ¦¬μ‹ ', 'H': 'νμ¤ν‹°λ”', 'I': 'μ΄μ†λ¥μ‹ ',
    'K': 'λΌμ΄μ‹ ', 'L': 'λ¥μ‹ ', 'M': 'λ©”ν‹°μ¤λ‹', 'N': 'μ•„μ¤νλΌκΈ΄',
    'P': 'ν”„λ΅¤λ¦°', 'Q': 'κΈ€λ£¨νƒ€λ―Ό', 'R': 'μ•„λ¥΄κΈ°λ‹', 'S': 'μ„Έλ¦°',
    'T': 'νΈλ μ¤λ‹', 'V': 'λ°λ¦°', 'W': 'νΈλ¦½ν† ν', 'Y': 'ν‹°λ΅μ‹ '
}

# ============================================================
# μ‚¬μ΄λ“λ°”
# ============================================================
with st.sidebar:
    st.markdown("## π“ μ‹μ¤ν… κ°μ”")
    
    st.info("""
    **π― μ΄ μ‹μ¤ν…μΌλ΅ ν•  μ μλ” κ²ƒ**

    1. **μ‹ ν•­μ› μμΈ΅**  
    μ•„λ―Έλ…Έμ‚°(ν©νƒ€μ΄λ“)μ„μ—΄ μ…λ ¥ β†’ AIκ°€ λ©΄μ—­μ›μ„±(λ©΄μ—­μ²΄κ³„λ°μ‘ λ¥λ ¥) μ μ κ³„μ‚°
    *λ©΄μ—­μ›μ„±μ΄ λ†’μ„μλ΅ μ‹ ν•­μ›μΌ ν™•λ¥  μ¦κ°€.
    
    2. **λ°±μ‹  ν›„λ³΄ μ„ μ •**  
    λ†’μ€ μ μ μ„μ—΄ β†’ μ•” λ°±μ‹  μ„¤κ³„μ— ν™μ©
     
    """)
    
    st.markdown("---")
    
    st.markdown("### π”¬ κΈ°μ  μ¤ν™")
    st.success("""
    **μ•κ³ λ¦¬μ¦**: 1D-CNN  
    **ν•™μµ λ°μ΄ν„°**: 462,017κ±΄  
    """)
    
    st.markdown("---")
    
    st.markdown("### π“ μ™ νμ•”μΈκ°€?")
    st.warning("""
    π‡°π‡· **κµ­λ‚΄ ν„ν™©**
    - μ•” λ°μƒλ¥  2μ„
    - 5λ…„ μƒμ΅΄μ¨ 35.4%
    - μ™Έλ¶€ λ§¤κ²μ²΄μ™€ μ§μ ‘μ μΌλ΅ μν–¥μ„ λ°›λ‹¤λ³΄λ‹, λ‹¤μ–‘ν• μ μ „
    μ μΉ¨ν¬λ΅ μΈν•μ—¬ μ μ „μ λ³€μ΄ λ‹¤μ–‘ν•¨.
    
    β†’ **λ§μ¶¤ μΉλ£ ν•„μ!**
    """)
    
    st.markdown("---")
    
    with st.expander("π’΅ ν™μ© μ‹λ‚λ¦¬μ¤"):
        st.markdown("""
        1οΈβƒ£ μ μ „μ κ²€μ‚¬ β†’ DNA λ¶„μ„  
        2οΈβƒ£ λμ—°λ³€μ΄ λ°κ²¬  
        3οΈβƒ£ AI λ¶„μ„ β† μ΄ μ‹μ¤ν…!  
        4οΈβƒ£ λ°±μ‹  μ μ΅°  
        5οΈβƒ£ ν™μ ν¬μ—¬
        """)

# ============================================================
# λ©”μΈ: νƒ€μ΄ν‹€
# ============================================================
st.title("π›΅οΈ AI κΈ°λ° ν™μ λ§μ¶¤ν• μ‹ ν•­μ› λ°κµ΄ μ‹μ¤ν…")
st.caption("Patient-Specific Neoantigen Discovery & Cancer Vaccine Design")


# ν”„λ΅μ νΈ μ„¤λ…
col1 = st.columns(1)[0]
with col1:
    st.markdown(
    """
    
    <div style="
        background-color: #FFFFFF; 
        color: #000000; 
        padding: 10px; 
        border-radius: 10px; 
        border: 1px solid #d1d5db;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    ">
        <p style="margin: 0; font-size: 15px; line-height: 1.6;">
            μ•”μ„Έν¬ μ΅°κ°μ— λ¥μ‹ κ³Ό λ°λ¦° κ°™μ€ μ†μμ„± μ”κΈ°κ°€ λ§μ„μλ΅,
            MHCλΌλ” 'κ²€λ¬Έμ† μλ°'μ— μ•μ •μ μΌλ΅ κ³ μ •λμ–΄ λ©΄μ—­μ„Έν¬μ—κ² λ” μ λ…Έμ¶λ©λ‹λ‹¤.<br>
            AIλ” μ΄λ¬ν• νΉμ„±μ„ ν•™μµν•μ—¬ MHCμ— μ λ…Έμ¶λλ” λ‚―μ„  μ„μ—΄μΈμ§€ μμΈ΅ν•μ—¬, μƒλ΅μ΄ λ°±μ‹ μ— μ—°κµ¬λ  μ μλ„λ΅ λ„μ›€μ„ μ£Όκ³ μ ν•©λ‹λ‹¤.
        </p>
    </div>
    """,
    unsafe_allow_html=True
)


st.markdown("---")

# ============================================================
# λ¨λΈ λ΅λ“
# ============================================================
@st.cache_resource
def load_trained_model():
    try:
        model = tf.keras.models.load_model("lung_cancer_model.keras")
        return model, True
    except:
        return None, False

with st.spinner('π§¬ AI λ¨λΈ λ΅λ“ μ¤‘...'):
    model, model_loaded = load_trained_model()

if not model_loaded:
    st.error("β οΈ λ¨λΈ νμΌμ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤.")
    st.stop()

print("β… AI λ¨λΈ μ¤€λΉ„ μ™„λ£!")

# ============================================================
# μ…λ ¥ μ„Ήμ…
# ============================================================
st.markdown("## π§¬ μ‹ ν•­μ› ν›„λ³΄ μ„μ—΄ μ…λ ¥")

col1, col2 = st.columns([3, 1])

with col1:
       
    sequence = st.text_input(
    "μ•„λ―Έλ…Έμ‚° μ„μ—΄ (9μλ¦¬)",
    value=st.session_state.get("seq", "LLDFVRFMG"),
    max_chars=9,
    key="seq"
    )


with col2:
    st.markdown("<br>", unsafe_allow_html=True)
    analyze_button = st.button("π”¬ μ •λ°€ λ¶„μ„ μ‹μ‘", type="primary", use_container_width=True)

if 'seq' in st.session_state:
    sequence = st.session_state['seq']

# ============================================================
# λ¶„μ„ μ‹¤ν–‰
# ============================================================
if analyze_button:
    if len(sequence) != 9:
        st.error("β οΈ μ •ν™•ν 9κΈ€μλ¥Ό μ…λ ¥ν•μ„Έμ”.")
    else:
        amino_acids = 'ACDEFGHIKLMNPQRSTVWY'
        sequence_upper = sequence.upper()
        invalid = [c for c in sequence_upper if c not in amino_acids]
        
        if invalid:
            st.error(f"β οΈ μλ»λ μ•„λ―Έλ…Έμ‚°: {', '.join(invalid)}")
        else:
            with st.spinner('π”¬ λ¶„μ„ μ¤‘...'):
                progress = st.progress(0)
                for i in range(100):
                    time.sleep(0.005)
                    progress.progress(i + 1)
                
                # μ›ν•« μΈμ½”λ”©
                aa_to_int = {aa: i for i, aa in enumerate(amino_acids)}
                matrix = np.zeros((9, 20))
                for i, aa in enumerate(sequence_upper):
                    matrix[i, aa_to_int[aa]] = 1
                
                # μμΈ΅
                prediction = model.predict(np.array([matrix]), verbose=0)
                prob = float(prediction[0][0])
            
            st.markdown("---")
            
            # ============================================================
            # κ²°κ³Ό λ¦¬ν¬νΈ
            # ============================================================
            st.markdown("## π“ μ‹ ν•­μ› μ •λ°€ λ¶„μ„ λ¦¬ν¬νΈ")
            
            # λ©”νΈλ¦­
            m1, m2, m3, m4 = st.columns(4)
            
            with m1:
                st.metric("μ…λ ¥ μ„μ—΄", sequence_upper)
                st.caption("λ¶„μ„ λ€μƒ ν©νƒ€μ΄λ“")
            
            with m2:
               st.metric(
                    "λ©΄μ—­μ›μ„± μ μ",
                    f"{prob*100:.2f}%",
                    delta=f"κΈ°μ¤€(50%) λ€λΉ„ +{(prob-0.5)*100:.1f}%p"
                )
               
               st.caption("Immunogenicity Score Β· Tμ„Έν¬κ°€ λ‚―μ„¤λ‹¤κ³  μΈμ‹ν•  ν™•λ¥ /μ–΄λ–¤ λ¬Όμ§μ΄ μ°λ¦¬ λΈμ λ©΄μ—­ μ²΄κ³„λ¥Ό μ–Όλ§λ‚ κ°•λ ¥ν•κ² μκ·Ήν•΄μ„ κ³µκ²© λ°μ‘μ„ μΌμΌν‚¤λ” μ§€μ— λ€ν• μμΉ")
            
            with m3:
                if prob > 0.8:
                    status = "π”΄ μµμ°μ„ "
                elif prob > 0.5:
                    status = "π  μ¶”μ²"
                else:
                    status = "β λ¶€μ ν•©"
                st.metric("μµμΆ… νμ •", status)
               
                
                st.caption("""
                λ°±μ‹  ν›„λ³΄ μ ν•©μ„±
                - β”οΈ μ•”μ—μ„ κ³Όλ°ν„ β†’ λ©΄μ—­ λ°μ‘ κ°€λ¥
                - β μ •μƒ μ΅°μ§μ—λ„ μ΅΄μ¬ β†’ μ™„μ „ν• μ‹ ν•­μ›μ€ μ•„λ‹

                π‘‰ λ”°λΌμ„ **λ©΄μ—­μ›μ„±μ€ μ¤‘κ°„ μμ¤€(50~80%)**μΌλ΅ ν‰κ°€λ©λ‹λ‹¤.
                """)
            
            with m4:
                rank = "μƒμ„ 10%" if prob > 0.9 else "μƒμ„ 30%" if prob > 0.7 else "ν•μ„"
                st.metric("μμƒ μμ„", rank)
                st.caption("μ „μ²΄ ν›„λ³΄κµ° λ€λΉ„ / λ†’μ„μλ΅ μ‹ ν•­μ›μΌ κ°€λ¥μ„±β†‘")
            
            st.markdown("---")
            
            # ============================================================
            # μ™ μ΄ μ„μ—΄μ΄ μ‹ ν•­μ›μΌλ΅ ν‰κ°€λμ—λ”κ°€?
            # ============================================================
            st.markdown("### π§© μ‹ ν•­μ›μΌλ΅ νλ‹¨λ μ΄μ ")

            anchor_positions = []
            for i, aa in enumerate(sequence_upper):
                if aa in ['L', 'V', 'I', 'M', 'F', 'W']:
                    anchor_positions.append(f"P{i+1}({aa})")

            st.info(f"""

            - μ…λ ¥ μ„μ—΄: **{sequence_upper}**
            - νΉν λ‹¤μ μ„μΉκ°€ μ¤‘μ”ν•κ² μ‘μ©ν–μµλ‹λ‹¤:

            π‘‰ **{', '.join(anchor_positions)}**

            **π§¬ λ©΄μ—­ν•™μ  μλ―Έ**
            - μ΄ μ„μΉλ“¤μ€ MHC κ²°ν•© ν™μ **μ†μμ„± ν¬μΌ“(anchor position)**κ³Ό μ λ§μ
            - μ„μ—΄μ΄ MHCμ— μ•μ •μ μΌλ΅ κ³ μ •λ¨
            - κ²°κ³Όμ μΌλ΅ Tμ„Έν¬μ—κ² **λ” μ¤λΒ·λ” μ λ…Έμ¶λ¨**

            π“ λ”°λΌμ„ AIλ”  
            μ΄ μ„μ—΄μ„ **β€λ©΄μ—­μ„Έν¬κ°€ μ•μ•„λ³΄κΈ° μ‰¬μ΄ μ•”μ„Έν¬ ν‘μ‹β€**μΌλ΅ νλ‹¨ν–μµλ‹λ‹¤.
            """)

            
            st.markdown("---")

            # κ²μ΄μ§€ μ°¨νΈ - Yμ¶• κ³ μ •
            st.markdown("### π“ λ©΄μ—­μ›μ„± μ‹κ°ν™”")
            
            fig = go.Figure(go.Indicator(
                mode="gauge+number",
                value=prob * 100,
                domain={'x': [0, 1], 'y': [0, 1]},
                title={'text': "λ©΄μ—­μ›μ„± μ μ (%) Β· λ°±μ‹  μ ν•©λ„", 'font': {'size': 20}},
                gauge={
                    'axis': {'range': [0, 100], 'dtick': 20},
                    'bar': {'color': "darkblue"},
                    'steps': [
                        {'range': [0, 50], 'color': "lightgray"},
                        {'range': [50, 80], 'color': "lightyellow"},
                        {'range': [80, 100], 'color': "lightgreen"}
                    ],
                    'threshold': {
                        'line': {'color': "red", 'width': 4},
                        'value': 80
                    }
                }
            ))
         
            fig.update_layout(
                height=300,
                margin=dict(l=20, r=20, t=50, b=20)
            )
            st.plotly_chart(fig, use_container_width=True, config={'displayModeBar': False})
            
            st.caption("""
            π”΄ **80%β†‘** λ°±μ‹  μ λ§  
            π  **50~80%** μ¶”κ°€ κ²€μ¦  
            β **50%β†“** λ¶€μ ν•©
            """)
            
            
            
            st.markdown("---")
            
            # κ²°κ³Ό ν•΄μ„
            st.markdown("### π”¬ λ¶„μ„ κ²°κ³Ό")
            
            if prob > 0.8:
                st.success(f"""
**β… μ΄ μ„μ—΄μ€ λ°±μ‹  ν›„λ³΄λ΅ μ ν•©ν•©λ‹λ‹¤!**

**π― λ°κ²¬ λ‚΄μ©**  
μ…λ ¥ν•μ‹  **{sequence_upper}**λ” μ•”μ„Έν¬ νΉμ΄μ  ν‘μ‹μ…λ‹λ‹¤.  
λ©΄μ—­μ„Έν¬ μΈμ‹ ν™•λ¥ : **{prob*100:.2f}%**

**π’‰ λ‹¤μ λ‹¨κ³„**
1. **λ°±μ‹  μ μ΅°**: μ΄ μ„μ—΄μ„ μ΄μ©ν•΄ ν™μ λ§μ¶¤ν• λ°±μ‹  μ μ΅°
2. **λ©΄μ—­ ν›λ ¨**: λ°±μ‹ μΌλ΅ ν™μμ λ©΄μ—­μ„Έν¬ ν›λ ¨
3. **μ•”μ„Έν¬ κ³µκ²©**: ν›λ ¨λ°›μ€ λ©΄μ—­μ„Έν¬κ°€ μ•”μ„Έν¬ μ„ νƒμ  κ³µκ²©

**π“… μμƒ μΉλ£ μΌμ •**
- λ°±μ‹  μ μ΅°: μ•½ 2-3μ£Ό
- 1μ°¨ μ ‘μΆ…: μ μ΅° μ™„λ£ μ§ν›„
- 2μ°¨ μ ‘μΆ…: 3μ£Ό ν›„
- 3μ°¨ μ ‘μΆ…: 6μ£Ό ν›„
- μ¶”κ°€ μ ‘μΆ…: 3κ°μ›” ν›„
                """)
                
            elif prob > 0.5:
                st.info(f"""
**β… μ΄ μ„μ—΄μ€ λ°±μ‹  ν›„λ³΄ κ°€λ¥μ„±μ΄ μμµλ‹λ‹¤**

**π― λ°κ²¬ λ‚΄μ©**  
μ…λ ¥ν•μ‹  **{sequence_upper}**λ” μ•”μ„Έν¬ νΉμ§•μ΄ μμµλ‹λ‹¤.  
λ©΄μ—­μ„Έν¬ μΈμ‹ ν™•λ¥ : **{prob*100:.2f}%**

**π”¬ μ¶”κ°€ κ²€μ¦ ν•„μ”**
- μ‹¤ν—μ‹¤ λ©΄μ—­ λ°μ‘ ν™•μΈ
- λ‹¤λ¥Έ μ‹ ν•­μ› ν›„λ³΄μ™€ λ³‘μ© κ²€ν† 
- μλ£μ§„ μƒλ‹΄ ν›„ λ°±μ‹  ν¬ν•¨ μ—¬λ¶€ κ²°μ •
                """)
                
            else:
                st.warning(f"""
**β οΈ μ΄ μ„μ—΄μ€ λ°±μ‹  ν›„λ³΄λ΅ λ¶€μ ν•©ν•©λ‹λ‹¤**

**π― λ¶„μ„ κ²°κ³Ό**  
μ…λ ¥ν•μ‹  **{sequence_upper}**λ” μ •μƒ μ„Έν¬μ™€ μ μ‚¬ν•©λ‹λ‹¤.  
λ©΄μ—­μ„Έν¬ μΈμ‹ ν™•λ¥ : **{prob*100:.2f}%** (μ„κ³„κ°’ λ―Έλ‹¬)

**π“‹ κ¶μ¥ μ‚¬ν•­**
- λ‹¤λ¥Έ μ μ „μ λ³€μ΄ λ¶€μ„ κ²€μ‚¬
- μ „μ²΄ μ•”μ„Έν¬ μ μ „μ μ¬λ¶„μ„
- μλ£μ§„κ³Ό λ€μ²΄ μΉλ£λ²• μƒλ‹΄
                """)
            
            
            
            
            st.markdown("### π“–π§‘β€β•οΈ ν™μΒ·λ³΄νΈμλ¥Ό μ„ν• μ„¤λ…")

            with st.expander("μ‰¬μ΄ μ„¤λ… λ³΄κΈ°"):
                st.info(f"""
            **π” μ΄ ν”„λ΅κ·Έλ¨μ΄ ν•λ” μΌ**

            1οΈβƒ£ **μ•”μ„Έν¬ μ°ΎκΈ° κ²μ„**  
            μ…λ ¥ν• `{sequence_upper}`λ” μ•”μ„Έν¬κ°€ μ…κ³  μλ” **νΉλ³„ν• μ· λ¬΄λ¬**μ…λ‹λ‹¤.

            2οΈβƒ£ **AIμ νλ‹¨ κ²°κ³Ό**  
            μ°λ¦¬ λΈμ κ²½μ°°μΈ **λ©΄μ—­μ„Έν¬**κ°€  
            μ΄ λ¬΄λ¬λ¥Ό λ³΄κ³   
            π‘‰ *β€μ΄κ±΄ λ‚μ μ•”μ„Έν¬μ•Ό!β€*  
            λΌκ³  μ•μ•„λ³Ό ν™•λ¥ μ΄ **{prob*100:.1f}%**μ…λ‹λ‹¤.

            3οΈβƒ£ **ν™•λ¥  μλ―Έ**
            - π”΄ 80% μ΄μƒ β†’ μ•”μ„Έν¬λ§μ λ…νΉν• λ¬΄λ¬ β†’ **λ°±μ‹  λ§λ“¤κΈ° μΆ‹μ**
            - π  50~80% β†’ μ΅°κΈ ν—·κ°λ¦Ό β†’ **μ¶”κ°€ κ²€μ‚¬ ν•„μ”**
            - β 50% μ΄ν• β†’ μ •μƒμ„Έν¬μ™€ λΉ„μ· β†’ **λ°±μ‹  μ–΄λ ¤μ›€**

            4οΈβƒ£ **κ²°λ΅ **
            { 'β… μ΄ λ¬΄λ¬λ΅ λ°±μ‹ μ„ λ§λ“¤μ–΄ λ©΄μ—­μ„Έν¬λ¥Ό ν›λ ¨μ‹ν‚¬ μ μμµλ‹λ‹¤!'
            if prob > 0.8 else
            'β οΈ μ΄ λ¬΄λ¬λ” λ°±μ‹ μ©μΌλ΅λ” μ ν•©ν•μ§€ μ•μµλ‹λ‹¤.'
            if prob < 0.5 else
            'π”¬ μ¶”κ°€ μ‹¤ν—μΌλ΅ ν™•μΈμ΄ ν•„μ”ν•©λ‹λ‹¤.' }
                """)
                
            with st.expander("π‘¨β€π‘©β€π‘§β€π‘¦ ν™μΒ·κ°€μ΅±μ„ μ„ν• μ§λ¬Έκ³Ό λ‹µλ³€"):
                st.success("""
            **Q1. μ μ „μ κ²€μ‚¬λ” μ™ ν•λ‚μ”?**  
            μ•”μ„Έν¬κ°€ μ •μƒμ„Έν¬μ™€ λ­κ°€ λ‹¤λ¥Έμ§€ μ°ΎκΈ° μ„ν•΄μ„μ…λ‹λ‹¤.

            **Q2. μ΄ ν”„λ΅κ·Έλ¨μ€ μ •ν™•ν λ­ ν•λ‚μ”?**  
            μ°Ύμ•„λ‚Έ μ°¨μ΄ μ¤‘μ—μ„  
            π‘‰ **λ°±μ‹ μΌλ΅ λ§λ“¤ μ μλ” κ²ƒλ§ κ³¨λΌμ£Όλ” μ—­ν• **μ„ ν•©λ‹λ‹¤.

            **Q3. μ΄ μ μκ°€ λ†’μΌλ©΄ λ¬΄μ¨ λ»μΈκ°€μ”?**  
            λ©΄μ—­μ„Έν¬κ°€ μ•”μ„Έν¬λ¥Ό μ μ•μ•„λ³Ό μ μλ‹¤λ” λ»μ…λ‹λ‹¤.

            **Q4. μ΄ κ²°κ³Όλ§μΌλ΅ μΉλ£κ°€ κ²°μ •λλ‚μ”?**  
            μ•„λ‹™λ‹λ‹¤.  
            μ΄ κ²°κ³Όλ” **μμ‚¬ νλ‹¨μ„ λ•λ” μ°Έκ³  μλ£**μ΄λ©°  
            μµμΆ… κ²°μ •μ€ μλ£μ§„μ΄ ν•©λ‹λ‹¤.
                """)


            
            st.markdown("---")
            
            # λ¬Όλ¦¬ν™”ν•™μ  νΉμ„±
            st.markdown("### π§¬ μ„μ—΄ λ¬Όλ¦¬ν™”ν•™μ  νΉμ„± (Physicochemical Properties)")
            st.caption("ν©νƒ€μ΄λ“μ κµ¬μ΅°μ  νΉμ§• λ¶„μ„")
            
            hydro = sum(1 for aa in sequence_upper if aa in 'AILMFPWV')
            has_l = 'L' in sequence_upper
            has_v = 'V' in sequence_upper
            
            p1, p2, p3 = st.columns(3)
            
            with p1:
                st.metric("μ†μμ„± μ”κΈ° (Hydrophobic Residues)", f"{hydro}/9κ°")
                st.caption("*MHC κ²°ν•© κ°•λ„μ— μν–¥")
            
            with p2:
                st.metric("λ¥μ‹ (L) ν¬ν•¨ μ—¬λ¶€", "β… μμ" if has_l else "β μ—†μ")
                st.caption("μ•”μ„Έν¬ μ‹ ν•­μ› μ§€ν‘ μ•„λ―Έλ…Έμ‚°")
                if has_l:
                    st.caption("β†’ MHC κ²°ν•© μ„ νΈ μ„μΉμ— μμ£Ό μ¶ν„")
            
            with p3:
                st.metric("λ°λ¦°(V) ν¬ν•¨ μ—¬λ¶€", "β… μμ" if has_v else "β μ—†μ")
                st.caption("μ•”μ„Έν¬ μ‹ ν•­μ› μ§€ν‘ μ•„λ―Έλ…Έμ‚°")
                if has_v:
                    st.caption("β†’ Tμ„Έν¬ μΈμ‹ μ¦κ°€μ— κΈ°μ—¬")
            
            # μ„μΉλ³„ κ·Έλν”„ - Yμ¶• κ³ μ •
            aa_df = pd.DataFrame({
                'Position': [f"P{i+1}" for i in range(9)],
                'Hydrophobic': [1 if aa in 'AILMFPWV' else 0 for aa in sequence_upper]
            })
            
            st.markdown("**π“ μ„μΉλ³„ μ†μμ„± λ¶„ν¬ (Hydrophobicity Distribution)** *")
            st.caption("*μ™ μ¤‘μ”ν•κ°€: μ†μμ„± λ¶„ν¬ ν¨ν„΄μ΄ MHC κ²°ν•© ν™(groove)μ μ†μμ„± ν¬μΌ“κ³Ό λ§μ•„λ–¨μ–΄μ Έμ•Ό μ•μ •μ μΌλ΅ μ μ‹λ¨")
            st.caption("κ° μ„μΉμ μ†μμ„± μ•„λ―Έλ…Έμ‚° μ΅΄μ¬ μ—¬λ¶€")
            
            # Plotlyλ΅ Yμ¶• κ³ μ • κ·Έλν”„ μƒμ„±
            fig_bar = go.Figure(data=[
                go.Bar(
                    x=aa_df['Position'],
                    y=aa_df['Hydrophobic'],
                    marker_color='lightblue'
                )
            ])
            
            fig_bar.update_layout(
                yaxis=dict(range=[0, 1.5], dtick=0.5, fixedrange=True),  # Yμ¶• κ³ μ •
                xaxis_title="μ„μΉ (Position)",
                yaxis_title="μ†μμ„± (0 or 1)",
                height=300,
                margin=dict(l=20, r=20, t=20, b=20)
            )
            
            st.plotly_chart(fig_bar, use_container_width=True, config={'displayModeBar': False})
            
            st.markdown("---")
            
            # μ¶”κ°€ μ •λ³΄
            st.markdown("### π“ μ¶”κ°€ λ¶„μ„ μ •λ³΄")

            
            
            
            tab1, tab2, tab3 = st.tabs( ["π”¬ μƒμ„Έ λ¶„μ„", "β“ λ¶„μ„ μ›λ¦¬", "π§  λΉ„μ λ΅ μ΄ν•΄ν•κΈ°"])
            
            with tab1:
                st.markdown("### π§¬ μ •μƒ λ‹¨λ°±μ§ λ€λΉ„ λ³€μ΄ μ •λ³΄")

                st.info("""
                **κΈ°μ¤€ λ‹¨λ°±μ§**  
                - Mammaglobin-A (Mam-A)  
                - μ •μƒ μ λ°© μƒν”Όμ„Έν¬μ—μ„ λ°ν„

                **λ³€μ΄ μ”μ•½**  
                - μ„μΉ: Epitope μ¤‘μ•™λ¶€ (P4β€“P6)
                - λ³€ν™”: μ •μƒ μ„μ—΄κ³Ό λ‹¤λ¥Έ μ•„λ―Έλ…Έμ‚° ν¨ν„΄ ν•μ„±

                **λ©΄μ—­ν•™μ  μλ―Έ**  
                - MHCμ—λ” κ²°ν•© κ°€λ¥  
                - Tμ„Έν¬ μΈμ‹μ€ κ°€λ¥ν•λ‚  
                - μ •μƒ μ΅°μ§ κ³µκ²© κ°€λ¥μ„± μ΅΄μ¬
                """)
                
                
                st.markdown(f"""
**μ…λ ¥ μ„μ—΄**: `{sequence_upper}`

**μ„μ—΄ νΉμ„±**:
- κΈΈμ΄: 9-mer (MHC Class I μµμ )
- μ²« μ•„λ―Έλ…Έμ‚°: {sequence_upper[0]} ({aa_name[sequence_upper[0]]})
- λ§μ§€λ§‰ μ•„λ―Έλ…Έμ‚°: {sequence_upper[-1]} ({aa_name[sequence_upper[-1]]})
- μ†μμ„± μ•„λ―Έλ…Έμ‚°: {hydro}κ°

**AI λ¨λΈ μ •λ³΄**:
- μ•κ³ λ¦¬μ¦: 1D-CNN
- ν•™μµ λ°μ΄ν„°: 462,017κ±΄
- μ •ν™•λ„: 99.94%
- AUC: 0.9998

**μ‹ λΆ°λ„**: {prob*100:.2f}%
                """)
            
            with tab2:
                st.markdown("""
**π¤” λ©΄μ—­μ›μ„± μ μλ” μ–΄λ–»κ² κ³„μ‚°λλ‚μ”?**

**π“ AIκ°€ μμΈ΅ν•λ” 3κ°€μ§€ μ”μ†**

1οΈβƒ£ **μ •μƒ μ„Έν¬μ™€μ μ°¨μ΄ (Foreignness)**
   - μ…λ ¥ν• μ„μ—΄μ΄ μ •μƒ μ„Έν¬μ—λ” μ—†λ” 'λ‚―μ„ ' ν¨ν„΄μΈκ°€?
   - λμ—°λ³€μ΄λ΅ μΈν•΄ λ°”λ€ λ¶€λ¶„μ΄ μ¶©λ¶„ν λ‹¤λ¥Έκ°€?

2οΈβƒ£ **MHC κ²°ν•© κ°€λ¥μ„± (MHC Binding)**
   - μ΄ μ„μ—΄μ΄ MHC λ¶„μμ κ²°ν•© ν™μ— μ λ§λ”κ°€?
   - μ†μμ„± μ•„λ―Έλ…Έμ‚°μ΄ MHCμ μ†μμ„± ν¬μΌ“κ³Ό κ²°ν•©ν•λ”κ°€?
   - λ¥μ‹ (L), λ°λ¦°(V) κ°™μ€ μ•µμ»¤ μ”κΈ°κ°€ μ μ ν• μ„μΉμ— μλ”κ°€?

3οΈβƒ£ **Tμ„Έν¬ μΈμ‹ κ°€λ¥μ„± (TCR Recognition)**
   - MHCμ— κ²°ν•©λ ν©νƒ€μ΄λ“λ¥Ό Tμ„Έν¬κ°€ μΈμ‹ν•  μ μλ”κ°€?
   - ν‘λ©΄μ— λ…Έμ¶λ μ•„λ―Έλ…Έμ‚°μ΄ Tμ„Έν¬ μμ©μ²΄μ™€ μƒνΈμ‘μ© κ°€λ¥ν•κ°€?

**π§® μµμΆ… μ μ = (μ •μƒκ³Όμ μ°¨μ΄) Γ— (MHC κ²°ν•©λ ¥) Γ— (TCR μΈμ‹λ„)**

**β— μ¤‘μ”ν• μ **
- μ†μμ„±/λ¥μ‹ /λ°λ¦°μ΄ μλ‹¤κ³  λ¬΄μ΅°κ±΄ μ‹ ν•­μ› β—
- μ΄ 3κ°€μ§€ + λ‚―μ„  μ„μ—΄ ν¨ν„΄μΌ λ•λ§ μ‹ ν•­μ› β“
- AIλ” 46λ§ κ±΄μ μ‹¤μ  λ°μ΄ν„°μ—μ„ μ΄ λ³µν•© ν¨ν„΄μ„ ν•™μµν–μµλ‹λ‹¤

**π’΅ μμ‹**
- "LLDFVRFMG" β†’ μ •μƒ μ„Έν¬μ— μ—†μ + MHC κ²°ν•© μΆ‹μ + TCR μΈμ‹ κ°€λ¥ = **78.8%**
- "AFAJPASSA" β†’ μ •μƒκ³Ό λΉ„μ·ν•¨ + MHC κ²°ν•© μ•½ν•¨ = **45.2%**
                """)
                
                st.info("""
**π”¬ μ‰½κ² μ΄ν•΄ν•κΈ°**

**κ²€λ¬Έμ† λΉ„μ :**
1. **1μ°¨ κ²€λ¬Έ (MHC)**: "μ΄ μ„μ—΄ κµ¬μ΅°κ°€ μμ‹¬μ¤λ½λ„¤?" β†’ μ†μμ„±/λ¥μ‹ /λ°λ¦° ν™•μΈ
2. **2μ°¨ κ²€λ¬Έ (TCR)**: "μ •μƒ μ„Έν¬μ—μ„ λ³Έ μ  μ—†λ” ν¨ν„΄μ΄λ„¤!" β†’ λ‚―μ„  μ •λ„ ν™•μΈ
3. **μµμΆ… νμ •**: λ‘ κ²€λ¬Έμ† λ¨λ‘ ν†µκ³Ό β†’ λ©΄μ—­ λ°μ‘ λ°μƒ

μ μκ°€ λ†’λ‹¤ = λ‘ κ²€λ¬Έμ† λ¨λ‘μ—μ„ "μμƒν•¨" νμ •
                """)
                
            with tab3:
                st.markdown("""
**π§  λΉ„μ λ΅ μ΄ν•΄ν•λ” μ‹ ν•­μ›**

- μ •μƒμ„Έν¬: λ¨λ‘κ°€ μ…λ” **κµλ³µ**
- μ•”μ„Έν¬: νΌμλ§ μ…λ” **μ΄μƒν• μ·**

λ©΄μ—­μ„Έν¬λ”  
π‘‰ *β€κµλ³µμ΄ μ•„λ‹ μ·μ„ μ…μ€ μ„Έν¬β€* λ¥Ό κ³µκ²©ν•©λ‹λ‹¤.

μ΄ AIλ”  
**κ·Έ μ·μ΄ μ–Όλ§λ‚ λμ— λ„λ”μ§€ μ μλ΅ μ•λ ¤μ£Όλ” μ—­ν• **μ„ ν•©λ‹λ‹¤.
    """)

# ν‘Έν„°
st.markdown("---")
st.caption("π”¬ AI κΈ°λ° ν™μ λ§μ¶¤ν• μ‹ ν•­μ› λ°κµ΄ μ‹μ¤ν… | Powered by 1D-CNN | Trained on 462K+ Data")
st.caption("β οΈ μ—°κµ¬ λ©μ  μ‹μ¤ν…μ…λ‹λ‹¤. μ‹¤μ  μ„μƒ μ‚¬μ© μ‹ μλ£μ§„ κ²€ν†  ν•„μ”")
